<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Préparation Technicien Ambulancier</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      position: relative;
      min-height: 100vh;
      margin: 0;
    }
    .quiz-container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    .question {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: left;
      position: relative;
    }
    .flag-and-question {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .flag-button {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #555;
      cursor: pointer;
      transition: color 0.3s;
      margin-right: 10px;
    }
    .flag-button:hover {
      color: #007BFF;
    }
    .flag-button.red {
      color: red;
    }
    .flag-button.red:hover {
      color: red;
    }
    .answers {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin-left: 30px;
    }
    .answer-button {
      background-color: #d3d3d3;
      color: black;
      border: none;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
      text-align: left;
      position: relative;
    }
    .answer-button.correct {
      background-color: green;
      color: white;
    }
    .answer-button.incorrect {
      background-color: red;
      color: white;
    }
    .answer-button.selected {
      background-color: #555;
      color: white;
    }
    /* The check mark will be inserted at the beginning of a correctly answered button */
    .check-mark {
      margin-right: 5px;
      font-weight: bold;
    }
    .feedback-text {
      font-size: 20px;
      font-weight: bold;
    }
    .feedback-text.red {
      color: red;
    }
    .feedback-text.green {
      color: green;
    }
    /* Blue message for multiple correct answers missing */
    .missing-message {
      color: blue;
      font-style: italic;
    }
    .hidden {
      display: none;
    }
    #timer {
      font-size: 20px;
      font-weight: bold;
    }
    button {
      margin: 5px;
      padding: 10px;
      cursor: pointer;
    }
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="quiz-container">
    <h1>Préparation Technicien Ambulancier</h1>
    <p>Choisir un mode de jeu :</p>
    <button onclick="startExam()">Mode Examen (120 min)</button>
    <button onclick="chooseExerciseRange()">Mode Exercice</button>
    <button onclick="showMarkedQuestions()">Questions Marquées</button>
    <button onclick="showHistory()">Historique</button>
  </div>

  <div id="game" class="hidden">
    <p id="timer" class="hidden"></p>
    <div id="questions"></div>
    <p id="feedback" class="feedback-text hidden"></p>
    <p id="score" class="hidden"></p>
    <button id="endButton" class="hidden" onclick="endExam()">Soumettre</button>
  </div>

  <div id="exerciseRangePage" class="hidden">
    <h2>Choisissez une plage de questions</h2>
    <div id="exerciseRangeOptions"></div>
    <button onclick="goBackToHome()">Retour</button>
  </div>

  <div id="historyPage" class="hidden">
    <h2>Historique des examens</h2>
    <div id="historyContent"></div>
    <button id="resetCacheButton" onclick="resetCache()">Réinitialiser le cache</button>
    <button onclick="goBackToHome()">Retour</button>
  </div>

  <!-- Footer appears only on the home page -->
  <footer id="footer">
    Informatisé par Olivier Van Isacker<br>
    Olivier.vanisacker@cern.ch
  </footer>

  <script>
    const quiz = [
      {
        "question": "1.3.2. Lors d’une intervention impliquant plusieurs patients, qu’entend-on par « phase de chaos » ?",
        "answers": [
          "La première phase de l’évènement, dans laquelle la situation ne se déroule pas sous des conditions ordonnées.",
          "Des phases qui se répètent au cours de l’évènement et qui sont normales.",
          "Des approches mal structurées par des collaborateurs du service de sauvetage qui ne sont pas qualifiés pour tels événements.",
          "Un autre concept pour l’évaluation du patient – le délai jusqu’à ce qu’il n’existe plus de clarté sur l’état du patient."
        ],
        "correct": [0, 1]
      },
      {
        "question": "5.4.1 Combien d'heures de perfectionnement et de formation continue par an, un/e technicien/ne ambulancier/ière doit-il/elle suivre selon les directives de l'IAS ?",
        "answers": [
          "0",
          "40",
          "60",
          "100"
        ],
        "correct": [1]
      }
    ];

    let currentQuestion = 0;
    let score = 0;
    let mode = '';
    let timerInterval;
    let timeLeft;
    let numQuestions = 50;
    let shuffledQuiz = [];
    let examHistory = JSON.parse(localStorage.getItem('examHistory')) || [];
    let markedQuestions = JSON.parse(localStorage.getItem('markedQuestions')) || [];
    const exerciseResults = {};

    function startExam() {
      mode = 'exam';
      timeLeft = 120 * 60;
      numQuestions = Math.min(50, quiz.length);
      document.querySelector(".quiz-container").classList.add("hidden");
      // Hide footer on game pages
      document.getElementById("footer").style.display = "none";
      document.getElementById("game").classList.remove("hidden");
      document.getElementById("timer").classList.remove("hidden");
      document.getElementById("score").classList.remove("hidden");
      currentQuestion = 0;
      score = 0;
      showQuestions();
      startTimer();
    }

    function chooseExerciseRange() {
      document.querySelector(".quiz-container").classList.add("hidden");
      document.getElementById("footer").style.display = "none";
      document.getElementById("exerciseRangePage").classList.remove("hidden");
      const exerciseRangeOptions = document.getElementById("exerciseRangeOptions");
      exerciseRangeOptions.innerHTML = '';
      for (let i = 0; i < quiz.length; i += 30) {
        const start = i + 1;
        const end = Math.min(i + 30, quiz.length);
        const rangeButton = document.createElement("button");
        rangeButton.textContent = `${start} à ${end} (${exerciseResults[`${start}-${end}`] || 0}%)`;
        rangeButton.onclick = () => startExerciseRange(start - 1, end);
        exerciseRangeOptions.appendChild(rangeButton);
      }
    }

    function startExerciseRange(start, end) {
      mode = 'exercise';
      numQuestions = end - start;
      shuffledQuiz = quiz.slice(start, end);
      shuffledQuiz.sort(() => Math.random() - 0.5);
      document.getElementById("exerciseRangePage").classList.add("hidden");
      document.getElementById("footer").style.display = "none";
      document.getElementById("game").classList.remove("hidden");
      currentQuestion = 0;
      score = 0;
      document.getElementById("timer").classList.add("hidden");
      document.getElementById("score").classList.add("hidden");
      document.getElementById("feedback").classList.add("hidden");
      showQuestion();
    }

    function showMarkedQuestions() {
      shuffledQuiz = markedQuestions;
      mode = 'flagged';
      currentQuestion = 0;
      numQuestions = markedQuestions.length;
      document.querySelector(".quiz-container").classList.add("hidden");
      document.getElementById("footer").style.display = "none";
      document.getElementById("game").classList.remove("hidden");
      showQuestion();
    }

    function markQuestion(question) {
      const index = markedQuestions.findIndex(q => q.question === question.question);
      if (index === -1) {
        markedQuestions.push(question);
      } else {
        markedQuestions.splice(index, 1);
      }
      localStorage.setItem('markedQuestions', JSON.stringify(markedQuestions));
      const flagButton = document.querySelector(`.flag-button[data-question="${question.question}"]`);
      if (flagButton) {
        const isMarked = markedQuestions.some(markedQ => markedQ.question === question.question);
        flagButton.classList.toggle("red", isMarked);
        flagButton.textContent = "⚑";
      }
    }

    function showQuestions() {
      const questionsDiv = document.getElementById("questions");
      questionsDiv.innerHTML = "";
      const quizToShow = mode === 'exam' ? quiz.slice(0, numQuestions) : shuffledQuiz;
      quizToShow.forEach((q, index) => {
        const questionDiv = document.createElement("div");
        questionDiv.classList.add("question");
        const flagAndQuestion = document.createElement("div");
        flagAndQuestion.classList.add("flag-and-question");
        const flagButton = document.createElement("button");
        flagButton.classList.add("flag-button");
        flagButton.setAttribute("data-question", q.question);
        const isMarked = markedQuestions.some(markedQ => markedQ.question === q.question);
        flagButton.classList.toggle("red", isMarked);
        flagButton.textContent = "⚑";
        flagButton.onclick = () => markQuestion(q);
        flagAndQuestion.appendChild(flagButton);
        const questionText = document.createElement("p");
        questionText.textContent = q.question;
        flagAndQuestion.appendChild(questionText);
        questionDiv.appendChild(flagAndQuestion);
        const answersDiv = document.createElement("div");
        answersDiv.classList.add("answers");
        q.answers.forEach((ans, ansIndex) => {
          const answerButton = document.createElement("button");
          answerButton.textContent = ans;
          answerButton.classList.add("answer-button");
          answerButton.onclick = () => selectAnswer(index, ansIndex, answerButton);
          answersDiv.appendChild(answerButton);
        });
        questionDiv.appendChild(answersDiv);
        if (mode === 'exam') {
          document.getElementById("endButton").classList.remove("hidden");
        }
        questionsDiv.appendChild(questionDiv);
      });
      document.getElementById("feedback").textContent = "";
      document.getElementById("score").textContent = `Score: ${score}/${numQuestions}`;
    }

    // Display one question at a time for exercise/flagged modes.
    function showQuestion() {
      const questionsDiv = document.getElementById("questions");
      questionsDiv.innerHTML = "";
      if (!shuffledQuiz.length) {
        questionsDiv.innerHTML = "<p>Aucune question disponible.</p>";
        return;
      }
      if (currentQuestion >= numQuestions) {
        showFinalScore();
        return;
      }
      console.log("shuffledQuiz:", shuffledQuiz);
      console.log("currentQuestion:", currentQuestion, "sur", numQuestions);
      const q = shuffledQuiz[currentQuestion];
      const questionDiv = document.createElement("div");
      questionDiv.classList.add("question");
      const flagAndQuestion = document.createElement("div");
      flagAndQuestion.classList.add("flag-and-question");
      const flagButton = document.createElement("button");
      flagButton.classList.add("flag-button");
      flagButton.setAttribute("data-question", q.question);
      const isMarked = markedQuestions.some(markedQ => markedQ.question === q.question);
      flagButton.classList.toggle("red", isMarked);
      flagButton.textContent = "⚑";
      flagButton.onclick = () => markQuestion(q);
      flagAndQuestion.appendChild(flagButton);
      const questionText = document.createElement("p");
      questionText.textContent = q.question;
      flagAndQuestion.appendChild(questionText);
      questionDiv.appendChild(flagAndQuestion);
      const answersDiv = document.createElement("div");
      answersDiv.classList.add("answers");
      q.answers.forEach((ans, ansIndex) => {
        const answerButton = document.createElement("button");
        answerButton.textContent = ans;
        answerButton.classList.add("answer-button");
        answerButton.onclick = () => selectAnswer(currentQuestion, ansIndex, answerButton);
        answersDiv.appendChild(answerButton);
      });
      questionDiv.appendChild(answersDiv);
      if (mode === 'exercise' || mode === 'flagged') {
        const submitButton = document.createElement("button");
        submitButton.textContent = "Soumettre";
        const nextButton = document.createElement("button");
        nextButton.textContent = "Suivant";
        nextButton.style.display = "none";
        nextButton.onclick = nextQuestion;
        submitButton.onclick = function() {
          checkAnswer(currentQuestion);
          submitButton.style.display = "none";
          nextButton.style.display = "inline-block";
        };
        questionDiv.appendChild(submitButton);
        questionDiv.appendChild(nextButton);
        const endButton = document.createElement("button");
        endButton.textContent = "Terminer";
        endButton.onclick = resetQuiz;
        questionDiv.appendChild(endButton);
      }
      questionsDiv.appendChild(questionDiv);
    }

    function selectAnswer(questionIndex, answerIndex, button) {
      const q = shuffledQuiz[questionIndex];
      button.classList.toggle("selected");
    }

    // Function to move to the next question
    function nextQuestion() {
      currentQuestion++;
      showQuestion();
    }

    // Correction for exercise/flagged modes
    function checkAnswer(questionIndex) {
      const q = shuffledQuiz[questionIndex];
      const questionDiv = document.querySelector("#questions .question:nth-child(1)");
      const buttons = questionDiv.querySelectorAll(".answer-button");
      let candidateSelected = [];
      buttons.forEach((button, index) => {
        if (button.classList.contains("selected")) {
          candidateSelected.push(index);
        }
      });
      buttons.forEach((button, index) => {
        if (q.correct.includes(index)) {
          button.classList.add("correct");
          if (button.classList.contains("selected")) {
            if (!button.querySelector(".check-mark")) {
              button.insertAdjacentHTML("afterbegin", "<span class='check-mark'>✔ </span>");
            }
            button.classList.remove("selected");
          }
        } else if (button.classList.contains("selected")) {
          button.classList.add("incorrect");
          button.classList.remove("selected");
        }
      });
      const missingCorrect = q.correct.filter(correctIndex => !candidateSelected.includes(correctIndex));
      if (q.correct.length > 1 && missingCorrect.length > 0) {
        const messageElem = document.createElement("p");
        messageElem.className = "missing-message";
        messageElem.textContent = "Attention il y a plusieurs bonnes réponses";
        questionDiv.appendChild(messageElem);
      }
      const correctSelected = candidateSelected.filter(ans => q.correct.includes(ans)).length;
      const incorrectSelected = candidateSelected.length - correctSelected;
      if (correctSelected === q.correct.length && incorrectSelected === 0) {
        score++;
      }
      document.getElementById("score").textContent = `Score: ${score}/${numQuestions}`;
    }

    // Correction for exam mode
    function endExam() {
      clearInterval(timerInterval);
      const questionsDiv = document.getElementById("questions");
      const questionDivs = questionsDiv.querySelectorAll(".question");
      questionDivs.forEach((questionDiv, index) => {
        const q = quiz[index];
        const buttons = questionDiv.querySelectorAll(".answer-button");
        let candidateSelected = [];
        buttons.forEach((button, index) => {
          if (button.classList.contains("selected")) {
            candidateSelected.push(index);
          }
        });
        buttons.forEach((button, index) => {
          if (q.correct.includes(index)) {
            button.classList.add("correct");
            if (button.classList.contains("selected")) {
              if (!button.querySelector(".check-mark")) {
                button.insertAdjacentHTML("afterbegin", "<span class='check-mark'>✔ </span>");
              }
              button.classList.remove("selected");
            }
          } else if (button.classList.contains("selected")) {
            button.classList.add("incorrect");
            button.classList.remove("selected");
          }
        });
        const missingCorrect = q.correct.filter(idx => !candidateSelected.includes(idx));
        if (q.correct.length > 1 && missingCorrect.length > 0) {
          const messageElem = document.createElement("p");
          messageElem.className = "missing-message";
          messageElem.textContent = "Attention il y a plusieurs bonnes réponses";
          questionDiv.appendChild(messageElem);
        }
        if (mode === 'exam' && !markedQuestions.some(markedQ => markedQ.question === q.question)) {
          markedQuestions.push(q);
        }
      });
      localStorage.setItem('markedQuestions', JSON.stringify(markedQuestions));
      const percentage = (score / numQuestions) * 100;
      let feedbackMessage = '';
      if (percentage < 85) {
        feedbackMessage = "Retourne au fourgon ket";
        document.getElementById("feedback").classList.add("red");
        document.getElementById("feedback").classList.remove("green");
      } else {
        feedbackMessage = "Bravo champion tu es prêt!";
        document.getElementById("feedback").classList.add("green");
        document.getElementById("feedback").classList.remove("red");
      }
      document.getElementById("feedback").textContent = feedbackMessage;
      document.getElementById("feedback").classList.remove("hidden");
      document.getElementById("score").textContent = `Score final : ${score}/${numQuestions} (${percentage.toFixed(2)}%)`;
      examHistory.push(percentage);
      localStorage.setItem('examHistory', JSON.stringify(examHistory));
      displayHistory();
      document.getElementById("endButton").classList.add("hidden");
      if (!document.getElementById("game").querySelector("button#backButton")) {
        const backButton = document.createElement("button");
        backButton.textContent = "Retourner à l'accueil";
        backButton.id = "backButton";
        backButton.onclick = resetQuiz;
        document.getElementById("game").appendChild(backButton);
      }
    }

    function showFinalScore() {
      const percentage = (score / numQuestions) * 100;
      alert(`Vous avez terminé l'exercice avec un score de ${percentage.toFixed(2)}%`);
      const rangeKey = `${currentQuestion - numQuestions + 1}-${currentQuestion}`;
      exerciseResults[rangeKey] = percentage.toFixed(2);
      goBackToHome();
    }

    function resetQuiz() {
      currentQuestion = 0;
      score = 0;
      mode = '';
      numQuestions = 50;
      shuffledQuiz = [];
      document.getElementById("game").classList.add("hidden");
      document.querySelector(".quiz-container").classList.remove("hidden");
      // Show footer on home page
      document.getElementById("footer").style.display = "block";
      document.getElementById("timer").classList.add("hidden");
      document.getElementById("score").classList.add("hidden");
      document.getElementById("feedback").classList.add("hidden");
      const backButton = document.getElementById("game").querySelector("button#backButton");
      if (backButton) {
        backButton.remove();
      }
    }

    function showHistory() {
      document.querySelector(".quiz-container").classList.add("hidden");
      document.getElementById("historyPage").classList.remove("hidden");
      goBackToHomeFooter(false);
      displayHistory();
    }

    function displayHistory() {
      const historyContent = document.getElementById("historyContent");
      historyContent.innerHTML = "";
      if (examHistory.length === 0) {
        historyContent.textContent = "Aucun examen effectué.";
        return;
      }
      const historyList = document.createElement("ul");
      examHistory.forEach((score, index) => {
        const listItem = document.createElement("li");
        listItem.textContent = `Examen ${index + 1}: ${score.toFixed(2)}%`;
        historyList.appendChild(listItem);
      });
      historyContent.appendChild(historyList);
    }

    function goBackToHome() {
      document.getElementById("exerciseRangePage").classList.add("hidden");
      document.getElementById("historyPage").classList.add("hidden");
      document.querySelector(".quiz-container").classList.remove("hidden");
      // Show footer on home page
      document.getElementById("footer").style.display = "block";
    }

    function startTimer() {
      timerInterval = setInterval(function() {
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          endExam();
          return;
        }
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById("timer").textContent = `Temps restant : ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      }, 1000);
    }

    function resetCache() {
      localStorage.removeItem('examHistory');
      localStorage.removeItem('markedQuestions');
      examHistory = [];
      markedQuestions = [];
      alert("Le cache a été réinitialisé.");
    }
  </script>
</body>
</html>
